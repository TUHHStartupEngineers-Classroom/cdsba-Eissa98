{
  "hash": "9cff2a33b6474f988e0303cbaffb9d6e",
  "result": {
    "markdown": "---\ntitle: \"Matching and Subclassification\"\n---\n\n\n::: callout-note\nYou can delete everything in here and start fresh.\n:::\n\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-1_6e44883e7fe7f3a2b67a1e7720807c23'}\n\n```{.r .cell-code}\nmembership_data<- readRDS(\"D:/TU Hamburg/Semester_5/Causal Data Science for Business Analytics/Causal_Data_Science_Data/Causal_Data_Science_Data/membership.rds\")\n\nView(membership_data)\n```\n:::\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-2_ab65288e8e719387538163fa053cbb77'}\n\n```{.r .cell-code}\nlibrary(dagitty)\nlibrary(ggdag)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> \n#> Attaching package: 'ggdag'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> The following object is masked from 'package:stats':\n#> \n#>     filter\n```\n:::\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\ndag_model <- 'dag {\n  bb=\"0,0,1,1\"\n  \"card\" [exposure,pos=\"0.25,0.2\"]\n  \"Membership\" [pos=\"0.35,0.25\"]\n  \"avg_purch\" [outcome,pos=\"0.35,0.2\"]\n  Age [pos=\"0.25,0.25\"]\n  \"Membership\" -> \"card\"\n  \"Membership\" -> \"avg_purch\"\n  Age -> \"card\"\n  Age -> \"Membership\"\n  Age -> \"avg_purch\"\n}'\n\n# DAG with adjustment sets (and custom layout)\nggdag_adjustment_set(dag_model, shadow = T, text = F) +\n  guides(color = \"none\") +  # Turn off legend\n  geom_dag_text(color = NA) +\n  geom_dag_edges(edge_color = \"white\") +\n  geom_dag_label_repel(aes(label = name))\n```\n\n::: {.cell-output-display}\n![](07_matching_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-3_f665a96919f4f29289f55b11f57ad671'}\n\n```{.r .cell-code}\nlm_naive <- lm(avg_purch ~ card, data = membership_data)\nsummary(lm_naive)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = membership_data)\n#> \n#> Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -101.515  -20.684   -0.199   20.424  120.166 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  65.9397     0.3965  166.29   <2e-16 ***\n#> card         25.2195     0.6095   41.38   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 30.11 on 9998 degrees of freedom\n#> Multiple R-squared:  0.1462,\tAdjusted R-squared:  0.1461 \n#> F-statistic:  1712 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-4_0848cec2acfe75e3b82cb61111616c56'}\n\n```{.r .cell-code}\n# Load 'MatchIt' library\nlibrary(MatchIt)\n\n# Without specifying coarsening\nexact_matching <- matchit(card ~ avg_purch,\n               data = membership_data, \n               method = 'cem', \n               estimand = 'ATE')\n\nsummary(exact_matching)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> matchit(formula = card ~ avg_purch, data = membership_data, method = \"cem\", \n#>     estimand = \"ATE\")\n#> \n#> Summary of Balance for All Data:\n#>           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\n#> avg_purch       91.1592       65.9397          0.8356      1.059    0.2225\n#>           eCDF Max\n#> avg_purch   0.3281\n#> \n#> Summary of Balance for Matched Data:\n#>           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\n#> avg_purch       76.9367       76.5309          0.0134     1.0123     0.005\n#>           eCDF Max Std. Pair Dist.\n#> avg_purch   0.0149           0.162\n#> \n#> Sample Sizes:\n#>               Control Treated\n#> All           5768.   4232.  \n#> Matched (ESS) 4802.01 3224.93\n#> Matched       5755.   4232.  \n#> Unmatched       13.      0.  \n#> Discarded        0.      0.\n```\n:::\n:::\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-5_6d0c65a06e4e06dbd4834ba303e59beb'}\n\n```{.r .cell-code}\nnearest_neighbour <- matchit(card ~ avg_purch,\n              data = membership_data,\n              method = \"nearest\", \n              distance = \"mahalanobis\", \n              replace = T)\n\n\nsummary(nearest_neighbour)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> matchit(formula = card ~ avg_purch, data = membership_data, method = \"nearest\", \n#>     distance = \"mahalanobis\", replace = T)\n#> \n#> Summary of Balance for All Data:\n#>           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\n#> avg_purch       91.1592       65.9397          0.8239      1.059    0.2225\n#>           eCDF Max\n#> avg_purch   0.3281\n#> \n#> Summary of Balance for Matched Data:\n#>           Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\n#> avg_purch       91.1592        91.147          0.0004     1.0015    0.0002\n#>           eCDF Max Std. Pair Dist.\n#> avg_purch   0.0043           0.002\n#> \n#> Sample Sizes:\n#>               Control Treated\n#> All           5768.      4232\n#> Matched (ESS) 1308.81    4232\n#> Matched       2280.      4232\n#> Unmatched     3488.         0\n#> Discarded        0.         0\n```\n:::\n:::\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-6_2fd93720d235b089ce1d4e8d7fc3da1a'}\n\n```{.r .cell-code}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> \n#> Attaching package: 'dplyr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> The following objects are masked from 'package:stats':\n#> \n#>     filter, lag\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n#> The following objects are masked from 'package:base':\n#> \n#>     intersect, setdiff, setequal, union\n```\n:::\n\n```{.r .cell-code}\npropensity_score <- glm(card ~ avg_purch,\n                  data = membership_data,\n                  family = binomial(link = \"logit\"))\n\nmembership_data <- membership_data %>%\nmutate(propensity = predict(propensity_score, type = \"response\"))\n\ndf_ipw <- membership_data %>% mutate(\n  ipw = (card/propensity) + ((1-card) / (1-propensity)))\n\nmodel_ipw <- lm(avg_purch  ~ card,\n                data = df_ipw, \n                weights = ipw)\nsummary(model_ipw)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = df_ipw, weights = ipw)\n#> \n#> Weighted Residuals:\n#>     Min      1Q  Median      3Q     Max \n#> -356.38  -29.03   -0.34   30.70  429.30 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept) 76.44134    0.45973 166.276   <2e-16 ***\n#> card         0.08821    0.64967   0.136    0.892    \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 45.94 on 9998 degrees of freedom\n#> Multiple R-squared:  1.844e-06,\tAdjusted R-squared:  -9.818e-05 \n#> F-statistic: 0.01844 on 1 and 9998 DF,  p-value: 0.892\n```\n:::\n:::\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-7_cd7a224d6628d6b21f6fdd84ce8af2ec'}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nggplot(membership_data, aes(x = propensity)) +\ngeom_histogram(alpha = .8, color = \"white\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n#> `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n:::\n\n::: {.cell-output-display}\n![](07_matching_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}